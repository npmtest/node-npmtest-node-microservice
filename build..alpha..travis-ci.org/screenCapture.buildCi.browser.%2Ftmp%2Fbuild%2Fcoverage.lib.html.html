<html lang="en"><head>
    <title>Code coverage report for node-npmtest-node-microservice/node_modules/node-microservice/index.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-node-microservice">npmtest-node-microservice (v0.0.1)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-node-microservice/node_modules/node-microservice/index.js</span></h1>
    <h2>
        
        Statements: <span class="metric">13.64% <small>(12 / 88)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 20)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 26)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">13.79% <small>(12 / 87)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../index.html">All files</a> » <a href="index.html">node-npmtest-node-microservice/node_modules/node-microservice/</a> » index.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tbody><tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var amqp = require('amqplib');
var uuid = require('node-uuid');
var graylog2 = require('graylog2');
var logger={log:<span class="fstat-no" title="function not covered">function(){</span>},error:<span class="fstat-no" title="function not covered">function(){</span>}};
var cacheTable={};
var mqService={};
&nbsp;
//defer is discourage in most promise library so we define one for this particular situation
<span class="fstat-no" title="function not covered">function defer(timeout) {</span>
<span class="cstat-no" title="statement not covered">    var resolve, reject;</span>
<span class="cstat-no" title="statement not covered">    var promise = new Promise(<span class="fstat-no" title="function not covered">function() {</span></span>
<span class="cstat-no" title="statement not covered">        resolve = arguments[0];</span>
<span class="cstat-no" title="statement not covered">        reject = arguments[1];</span>
<span class="cstat-no" title="statement not covered">        setTimeout(reject, timeout, "Timeout");</span>
    });
<span class="cstat-no" title="statement not covered">    return {</span>
        resolve: resolve,
        reject: reject,
        promise: promise,
        timestamp:new Date().getTime()
    };
}
&nbsp;
exports.connect_amqp=<span class="fstat-no" title="function not covered">function(amqp_url, options){</span>
<span class="cstat-no" title="statement not covered">    return amqp.connect(amqp_url).then(<span class="fstat-no" title="function not covered">function (conn) {</span></span>
<span class="cstat-no" title="statement not covered">        return conn.createChannel().then(</span>
<span class="fstat-no" title="function not covered">            function onFulfilled(ch) {</span>
<span class="cstat-no" title="statement not covered">                if(options){</span>
<span class="cstat-no" title="statement not covered">                    logger=new graylog2.graylog(options);</span>
                }
<span class="cstat-no" title="statement not covered">                mqService.ch=ch;</span>
<span class="cstat-no" title="statement not covered">                var ok = ch.assertQueue('', {exclusive: true})</span>
                    .then(<span class="fstat-no" title="function not covered">function (qok) {</span>
<span class="cstat-no" title="statement not covered">                        return qok.queue;</span>
                    });
<span class="cstat-no" title="statement not covered">                mqService.ok=ok;</span>
<span class="cstat-no" title="statement not covered">                return ok;</span>
            });
    }).then(null, <span class="fstat-no" title="function not covered">function(err) {</span>
<span class="cstat-no" title="statement not covered">        console.error("Exception handled, reconnecting...\nDetail:\n" + err);</span>
<span class="cstat-no" title="statement not covered">        setTimeout(exports.connect_amqp(amqp_url), 5000);</span>
    });
};
&nbsp;
exports.send=<span class="fstat-no" title="function not covered">function(serviceName,message,timeout){</span>
<span class="cstat-no" title="statement not covered">    var messageStr=JSON.stringify(message);</span>
<span class="cstat-no" title="statement not covered">    var q = serviceName + "_queue";</span>
<span class="cstat-no" title="statement not covered">    var corrId = uuid();</span>
<span class="cstat-no" title="statement not covered">    var ok = mqService.ok;</span>
<span class="cstat-no" title="statement not covered">    var ch = mqService.ch;</span>
    //create a new Promise and waiting for resolve
<span class="cstat-no" title="statement not covered">    var df=defer(timeout);</span>
<span class="cstat-no" title="statement not covered">    cacheTable[corrId]=df;</span>
<span class="cstat-no" title="statement not covered">    ok = ok.then(<span class="fstat-no" title="function not covered">function (queue) {</span></span>
<span class="cstat-no" title="statement not covered">        return ch.consume(queue, maybeAnswer, {noAck: true})</span>
            .then(<span class="fstat-no" title="function not covered">function () {</span>
<span class="cstat-no" title="statement not covered">                return queue;</span>
            });
    });
<span class="cstat-no" title="statement not covered">    ok = ok.then(<span class="fstat-no" title="function not covered">function (queue) {</span></span>
        //console.log(' [x] Requesting'+ message);
<span class="cstat-no" title="statement not covered">        ch.sendToQueue(q, new Buffer(messageStr), {</span>
            correlationId: corrId, replyTo: queue
        });
    });
<span class="cstat-no" title="statement not covered">    return df.promise.then(</span>
<span class="fstat-no" title="function not covered">        function onFulfilled(rs){</span>
<span class="cstat-no" title="statement not covered">            if(JSON.parse(rs) == corrId) {</span>
<span class="cstat-no" title="statement not covered">                rs = undefined;</span>
<span class="cstat-no" title="statement not covered">                return rs;</span>
            }else{
<span class="cstat-no" title="statement not covered">                logger.log("Success","request@#$"+messageStr+"====response@#$"+rs,{duration:new Date().getTime()-df.timestamp, service:serviceName});</span>
<span class="cstat-no" title="statement not covered">                return JSON.parse(rs);</span>
            }
        },
<span class="fstat-no" title="function not covered">        function onReject(err){</span>
<span class="cstat-no" title="statement not covered">            logger.error("Timeout","request@#$"+messageStr+"====response@#$"+err,{duration:new Date().getTime()-df.timestamp, service:serviceName});</span>
<span class="cstat-no" title="statement not covered">            throw new Error(err);</span>
        }
    );
};
&nbsp;
<span class="fstat-no" title="function not covered">function maybeAnswer(msg) {</span>
<span class="cstat-no" title="statement not covered">    var corrId=msg.properties.correlationId;</span>
<span class="cstat-no" title="statement not covered">    var pro = cacheTable[corrId];</span>
<span class="cstat-no" title="statement not covered">    if(pro){</span>
<span class="cstat-no" title="statement not covered">        pro.resolve(msg.content.toString());</span>
<span class="cstat-no" title="statement not covered">        delete cacheTable[corrId];</span>
    }
}
&nbsp;
/**
 * Server Side function
 **/
&nbsp;
&nbsp;
/**
 *
 * @param amqp_url
 * @param service_name
 * @param pro (this function has to be a promise)
 * @param options (object)
 *      Must Have: noAck (boolean)
 *                 if noAck = True: the queue will send tasks to server and then discard regardless of the server's
 *                                  state.
 *                                  Warning: when having two or more servers, setting noAck to True will risk loosing
 *                                          message if one of the server that gets the messages goes offline.
 *                 if noAck = False: the queue will make sure the server get and finish the task with acknowledgements.
 *                                  Warning: if the server gets the tasks but fails to finish, the message will
 *                                          1. Timeout as determined by messageTtl option
 *                                          2. If the server goes offline, the tasks will be requeued and sent to the
 *                                              next available server.
 *                *We recommend setting noAck to False to guarantee message delivery and avoid loosing message when
 *                      multiple servers are online and working
 *      Optional :
 *              messageTtl (milliseconds) (must start a new queue if this option was just added, modified, or taken out)
 *                  Set Timeout for messages in the queue. This option has proven to be extremely helpful when the
 *                      server goes offline and comes back and the messages are requeued. If the messageTtl is set to
 *                      the same milliseconds as the client's timeout, the queue will make sure the server do not get
 *                      timed out messages that the client no longer cares about.
 *              *We recommend setting the messageTtl equal to the client's timeout parameter.
 *
 *              prefetch_num (integer bigger than or equal to 1)
 *                  Set the maximum number of acknowledgements the queue can wait from the server. In other words, it
 *                      is the maximum number of tasks one server can take each time. That said, this will only be
 *                      effective when the noAck is set to False. If prefetch_num is not passed in, the server will
 *                      simply take as many tasks as possible and this may cause a race condition. In our production
 *                      experience, we find that a number of 10 or 100 works just fine.
 *             *Only effective when noAck == False
 *
 *             durable (boolean)
 *                  Make the queue durable as stated on the RabbitMQ website. The default setting is false.
 *      Example:
 *              Our Safest/Most Used Options: {noAck:false, prefetch_num:10, messageTtl:60000}
 *              Simplest/Minimalist Options(best for just testing): {noAck:true}
 *
 *
 *
 */
exports.server_listen=<span class="fstat-no" title="function not covered">function(amqp_url,service_name,pro,options){</span>//pro has to be a promise
<span class="cstat-no" title="statement not covered">    var durable;</span>
<span class="cstat-no" title="statement not covered">    if(options.durable) {</span>
<span class="cstat-no" title="statement not covered">        durable = options.durable;</span>
    }else
<span class="cstat-no" title="statement not covered">        durable = false;</span>
&nbsp;
<span class="cstat-no" title="statement not covered">    var queueOptions={durable: durable};</span>
&nbsp;
<span class="cstat-no" title="statement not covered">    if(options.messageTtl)</span>
<span class="cstat-no" title="statement not covered">        queueOptions.messageTtl = options.messageTtl;</span>
&nbsp;
<span class="cstat-no" title="statement not covered">    amqp.connect(amqp_url).then(<span class="fstat-no" title="function not covered">function(conn) {</span></span>
<span class="cstat-no" title="statement not covered">        process.once('SIGINT', <span class="fstat-no" title="function not covered">function() {</span> <span class="cstat-no" title="statement not covered">conn.close(); </span>});</span>
<span class="cstat-no" title="statement not covered">        return conn.createChannel().then(<span class="fstat-no" title="function not covered">function(ch) {</span></span>
<span class="cstat-no" title="statement not covered">            var q = service_name + "_queue";</span>
<span class="cstat-no" title="statement not covered">            var ok = ch.assertQueue(q, queueOptions);</span>
<span class="cstat-no" title="statement not covered">            var ok = ok.then(<span class="fstat-no" title="function not covered">function() {</span></span>
<span class="cstat-no" title="statement not covered">                if(options.prefetch_num) {</span>
<span class="cstat-no" title="statement not covered">                    ch.prefetch(options.prefetch_num);</span>
                }
<span class="cstat-no" title="statement not covered">                return ch.consume(q, reply,{noAck:options.noAck});</span>
            });
<span class="cstat-no" title="statement not covered">            return ok.then(<span class="fstat-no" title="function not covered">function() {</span></span>
<span class="cstat-no" title="statement not covered">                console.log(' [x] Awaiting requests');</span>
            });
&nbsp;
<span class="fstat-no" title="function not covered">            function reply(msg) {</span>
<span class="cstat-no" title="statement not covered">                var content=JSON.parse(msg.content.toString());</span>
<span class="cstat-no" title="statement not covered">                pro(content).then(</span>
<span class="fstat-no" title="function not covered">                    function onFulfilled(response){</span>
<span class="cstat-no" title="statement not covered">                        if(!response) {</span>
<span class="cstat-no" title="statement not covered">                            response = msg.properties.correlationId;</span>
                        }
<span class="cstat-no" title="statement not covered">                        ch.sendToQueue(msg.properties.replyTo,</span>
                            new Buffer(JSON.stringify(response)),
                            {correlationId: msg.properties.correlationId});
<span class="cstat-no" title="statement not covered">                        if(!options.noAck) {</span>
<span class="cstat-no" title="statement not covered">                            ch.ack(msg);</span>
                        }
                    },
<span class="fstat-no" title="function not covered">                    function onReject(err){</span>
<span class="cstat-no" title="statement not covered">                        console.log(err);</span>
<span class="cstat-no" title="statement not covered">                        ch.sendToQueue(msg.properties.replyTo,</span>
                            new Buffer(JSON.stringify(err)),
                            {correlationId: msg.properties.correlationId});
<span class="cstat-no" title="statement not covered">                        if(!options.noAck) {</span>
<span class="cstat-no" title="statement not covered">                            if(options.ensureDone){</span>
<span class="cstat-no" title="statement not covered">                                ch.nack(msg);</span>
                            }else {
<span class="cstat-no" title="statement not covered">                                ch.ack(msg);</span>
                            }
                        }
                    }
                );
            }
        });
    }).then(null, <span class="fstat-no" title="function not covered">function(err){</span>
<span class="cstat-no" title="statement not covered">        console.error("Server has problem connecting, shutting down...\nDetail:\n" + err);</span>
<span class="cstat-no" title="statement not covered">        throw err;</span>
    });
};
&nbsp;</pre></td></tr>
</tbody></table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Tue Apr 18 2017 04:00:53 GMT+0000 (UTC)</div>
</div>


</body></html>